# CommonJS Visual Diagrams - Rspack Implementation

## Table of Contents

1. [CommonJS Dependency Flow](#commonjs-dependency-flow)
2. [CommonJS Template Rendering Pipeline](#commonjs-template-rendering-pipeline)
3. [CommonJS vs ESM Comparison](#commonjs-vs-esm-comparison)
4. [CommonJS Runtime Generation](#commonjs-runtime-generation)

> **Note**: For ConsumeShared integration patterns, see [CommonJS Integration with Module Federation](../module-federation/commonjs-integration.md).

---

## CommonJS Dependency Flow

### CommonJS Require Flow in Rspack

For Module Federation specific flows, see [CommonJS Integration with Module Federation](../module-federation/commonjs-integration.md).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMMONJS REQUIRE PROCESSING                  â”‚
â”‚                                                                 â”‚
â”‚ Input: const util = require('lodash');                         â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚               Dependency Detection                          â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  1. CommonJS Parser Analysis                                â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ Pattern: require('module_name')                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ Extract: module_name = "lodash"              â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ Context: CommonJS module context             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â””â”€ Create: CommonJSRequireDependency            â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                    â”‚                                        â”‚ â”‚
â”‚ â”‚                    â–¼                                        â”‚ â”‚
â”‚ â”‚  2. ConsumeShared Detection                                 â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ detect_consume_shared_context()                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ Check parent module type                     â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ Check incoming connections                   â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ Search for ConsumeShared ancestors           â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â””â”€ Result: None (Current Limitation)            â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              Template Generation                            â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  1. Runtime Template Selection                              â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ if consume_shared_key.is_some() {               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   // ConsumeShared template (Future)            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   template = ConsumeSharedTemplate              â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ } else {                                        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   // Standard CommonJS template                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   template = CommonJSRequireTemplate            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ }                                               â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                    â”‚                                        â”‚ â”‚
â”‚ â”‚                    â–¼                                        â”‚ â”‚
â”‚ â”‚  2. Code Generation                                         â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ Standard CommonJS:                              â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var util = __webpack_require__("lodash");       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ ConsumeShared (Future):                         â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var util = __webpack_require__.consumeShared(   â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   "default", "lodash", fallback                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ );                                              â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CommonJS Export Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COMMONJS EXPORTS PROCESSING                  â”‚
â”‚                                                                 â”‚
â”‚ Input: exports.helper = function() {...};                     â”‚
â”‚        module.exports = { util: value };                       â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              Export Pattern Detection                       â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  1. CommonJS Export Patterns                                â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ Pattern Types:                                  â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ exports.name = value                         â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ exports["name"] = value                      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ module.exports = value                       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â””â”€ module.exports.name = value                  â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                    â”‚                                        â”‚ â”‚
â”‚ â”‚                    â–¼                                        â”‚ â”‚
â”‚ â”‚  2. Dependency Creation                                     â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ exports.helper â†’ CommonJSExportsDependency      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ export_name: "helper"                        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â”œâ”€ value_range: AST position                    â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â””â”€ expression_range: full expression            â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚             ConsumeShared Integration                       â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  1. Context Detection (Enhanced)                            â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ get_consume_shared_key() {                      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   // Check if this module is accessed via       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   // ConsumeShared parent                       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   if let Some(key) = detect_context() {         â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     return Some(key);                           â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   }                                             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   return None;                                  â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ }                                               â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                    â”‚                                        â”‚ â”‚
â”‚ â”‚                    â–¼                                        â”‚ â”‚
â”‚ â”‚  2. Template Application                                    â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ if consume_shared_key.is_some() {               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   // Apply ConsumeShared semantics              â”‚   â”‚ â”‚  
â”‚ â”‚     â”‚   add_pure_annotation();                        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   enable_tree_shaking();                        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ }                                               â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CommonJS Template Rendering Pipeline

### CommonJS Require Template Processing

```mermaid
graph TD
    A[CommonJS Require] --> B{ConsumeShared Context?}
    
    B -->|Yes| C[ConsumeShared Template Path]
    B -->|No| D[Standard Template Path]
    
    C --> C1[Get Share Key]
    C1 --> C2[Generate ConsumeShared Call]
    C2 --> C3[Add Pure Annotation]
    C3 --> C4[Enable Tree-Shaking Analysis]
    
    D --> D1[Generate Standard Require]
    D1 --> D2[Apply Module ID]
    D2 --> D3[Generate Webpack Require]
    
    C4 --> E[Code Output]
    D3 --> E
    
    E --> F{Output Type}
    F -->|ConsumeShared| G["__webpack_require__.consumeShared('default', 'lodash', fallback)"]
    F -->|Standard| H["__webpack_require__('lodash')"]
    
    style C fill:#e1f5fe
    style D fill:#fff3e0
    style G fill:#e8f5e8
    style H fill:#ffebee
```

### CommonJS Export Template Processing

```mermaid
graph TD
    A[CommonJS Export] --> B[Parse Export Pattern]
    
    B --> C{Export Type}
    C -->|exports.name| D[Named Export]
    C -->|module.exports| E[Default Export]
    C -->|exports['name']| F[Dynamic Export]
    
    D --> D1[Extract Export Name]
    E --> E1[Handle Default Export]
    F --> F1[Handle Dynamic Key]
    
    D1 --> G[Generate Export Code]
    E1 --> G
    F1 --> G
    
    G --> H{ConsumeShared Context?}
    H -->|Yes| I[Add Tree-Shaking Metadata]
    H -->|No| J[Standard Export Generation]
    
    I --> K[Enhanced Export Code]
    J --> L[Standard Export Code]
    
    K --> M["/* ESM export */ exports.helper = helper;"]
    L --> N["exports.helper = helper;"]
    
    style I fill:#e1f5fe
    style J fill:#fff3e0
    style M fill:#e8f5e8
    style N fill:#ffebee
```

---

## CommonJS ConsumeShared Integration

### Integration Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 COMMONJS CONSUMESHARED INTEGRATION              â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                Current State (Limited)                      â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  CommonJS Module: utils.js                                  â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ const lodash = require('lodash');               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ const { debounce } = lodash;                    â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // Detection Result:                            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // âŒ ConsumeShared: None                       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // â¡ï¸  Standard require()                       â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚               Enhanced Integration (Future)                 â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  ConsumeShared Detection Enhancement:                       â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ 1. Parent Module Analysis                       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Check module.parent â†’ ConsumeShared       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â””â”€ Extract share_key from parent             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ 2. Incoming Connection Analysis                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Traverse incoming connections             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Find ConsumeShared origin modules         â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â””â”€ Propagate share context                   â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ 3. Fallback Module Relationship                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Identify as ConsumeShared fallback        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Inherit ConsumeShared properties          â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â””â”€ Enable federation features               â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              Implementation Challenges                      â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  Technical Limitations:                                     â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ 1. Module Resolution Timing                     â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ CommonJS resolved before ConsumeShared    â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Parent context not available at parse     â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â””â”€ Requires deferred analysis                â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ 2. Dependency Graph Complexity                  â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Circular dependency detection             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Multi-level module relationships          â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â””â”€ Cache invalidation challenges             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ 3. Code Generation Compatibility               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ CommonJS vs ESM template differences      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â”œâ”€ Runtime loader integration               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚    â””â”€ Tree-shaking annotation support          â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ConsumeShared Detection Flow for CommonJS

```mermaid
graph TD
    A[CommonJS require() call] --> B[Create CommonJSRequireDependency]
    
    B --> C[detect_consume_shared_context()]
    
    C --> D{Check Parent Module}
    D -->|Found| E[Parent is ConsumeShared?]
    D -->|Not Found| F[Check Incoming Connections]
    
    E -->|Yes| G[Extract Share Key]
    E -->|No| F
    
    F --> H{Any ConsumeShared Origins?}
    H -->|Yes| I[Extract Share Key from Origin]
    H -->|No| J[No ConsumeShared Context]
    
    G --> K[Return Share Key]
    I --> K
    J --> L[Return None]
    
    K --> M[Apply ConsumeShared Template]
    L --> N[Apply Standard Template]
    
    M --> O[Enhanced CommonJS with Federation Features]
    N --> P[Standard CommonJS require()]
    
    style G fill:#e8f5e8
    style I fill:#e8f5e8
    style J fill:#ffebee
    style M fill:#e1f5fe
    style N fill:#fff3e0
```

---

## CommonJS vs ESM Comparison

### Module System Comparison in Module Federation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              COMMONJS VS ESM IN MODULE FEDERATION               â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚        CommonJS         â”‚  â”‚          ESM            â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚                         â”‚       â”‚
â”‚ â”‚  Source Code:           â”‚  â”‚  Source Code:           â”‚       â”‚
â”‚ â”‚  const util =           â”‚  â”‚  import { debounce }    â”‚       â”‚
â”‚ â”‚    require('lodash');   â”‚  â”‚    from 'lodash';       â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚                         â”‚       â”‚
â”‚ â”‚  Dependency Type:       â”‚  â”‚  Dependency Type:       â”‚       â”‚
â”‚ â”‚  CommonJSRequire        â”‚  â”‚  ESMImportSpecifier     â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚                         â”‚       â”‚
â”‚ â”‚  ConsumeShared Support: â”‚  â”‚  ConsumeShared Support: â”‚       â”‚
â”‚ â”‚  âŒ Limited (Current)   â”‚  â”‚  âœ… Full Support        â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚                         â”‚       â”‚
â”‚ â”‚  Tree-Shaking:          â”‚  â”‚  Tree-Shaking:          â”‚       â”‚
â”‚ â”‚  âŒ Not Available       â”‚  â”‚  âœ… Full Support        â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚                         â”‚       â”‚
â”‚ â”‚  Pure Annotations:      â”‚  â”‚  Pure Annotations:      â”‚       â”‚
â”‚ â”‚  âŒ Not Applied         â”‚  â”‚  âœ… Applied             â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚                         â”‚       â”‚
â”‚ â”‚  Generated Code:        â”‚  â”‚  Generated Code:        â”‚       â”‚
â”‚ â”‚  var util =             â”‚  â”‚  /* ESM import */       â”‚       â”‚
â”‚ â”‚  __webpack_require__    â”‚  â”‚  var lodash =           â”‚       â”‚
â”‚ â”‚  ("lodash");            â”‚  â”‚  /* #__PURE__ */        â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚  __webpack_require__    â”‚       â”‚
â”‚ â”‚                         â”‚  â”‚  ("lodash");            â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                    â”‚                     â”‚                      â”‚
â”‚                    â–¼                     â–¼                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                    Runtime Behavior                         â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  CommonJS (Current):                                        â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ // Direct require - no federation benefits      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var util = __webpack_require__("lodash");       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // Loads from local node_modules                â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // No sharing, no version resolution            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // No tree-shaking optimization                 â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  ESM (Current):                                             â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ // ConsumeShared-aware loading                  â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var lodash = /* #__PURE__ */                    â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   __webpack_require__.consumeShared(            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     "default", "lodash", fallback               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   );                                            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // Supports sharing and version resolution      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // Enables tree-shaking optimization            â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚               Enhancement Roadmap                           â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  Phase 1: Detection Enhancement                             â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ âœ… Implement parent module detection            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ âœ… Add incoming connection analysis             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ âœ… Debug logging for investigation              â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  Phase 2: Template Integration                              â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ ğŸ”„ Extend template generation logic             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ ğŸ”„ Add ConsumeShared template for CommonJS      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ ğŸ”„ Implement pure annotation support            â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  Phase 3: Runtime Integration                               â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ â³ Integrate with ConsumeShared runtime         â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â³ Add tree-shaking analysis support            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ â³ Enable version resolution                     â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Feature Compatibility Matrix

```mermaid
graph TB
    subgraph "Module Federation Features"
        F1[ConsumeShared Support]
        F2[Tree-Shaking Analysis]
        F3[Pure Annotations]
        F4[Version Resolution]
        F5[Share Scope Integration]
        F6[Fallback Handling]
    end
    
    subgraph "ESM Support Status"
        E1[âœ… Full Support]
        E2[âœ… Full Support]
        E3[âœ… Full Support]
        E4[âœ… Full Support]
        E5[âœ… Full Support]
        E6[âœ… Full Support]
    end
    
    subgraph "CommonJS Support Status"
        C1[âŒ Limited/None]
        C2[âŒ Not Available]
        C3[âŒ Not Applied]
        C4[âŒ Not Available]
        C5[âŒ Limited Access]
        C6[âœ… Basic Support]
    end
    
    F1 --> E1
    F1 --> C1
    F2 --> E2
    F2 --> C2
    F3 --> E3
    F3 --> C3
    F4 --> E4
    F4 --> C4
    F5 --> E5
    F5 --> C5
    F6 --> E6
    F6 --> C6
    
    style E1 fill:#e8f5e8
    style E2 fill:#e8f5e8
    style E3 fill:#e8f5e8
    style E4 fill:#e8f5e8
    style E5 fill:#e8f5e8
    style E6 fill:#e8f5e8
    
    style C1 fill:#ffebee
    style C2 fill:#ffebee
    style C3 fill:#ffebee
    style C4 fill:#ffebee
    style C5 fill:#fff3e0
    style C6 fill:#e8f5e8
```

---

## CommonJS Runtime Generation

### CommonJS Template Code Generation Pipeline

```mermaid
flowchart TD
    A[CommonJS Dependency] --> B{ConsumeShared Context?}
    
    B -->|Detected| C[ConsumeShared CommonJS Template]
    B -->|None| D[Standard CommonJS Template]
    
    C --> C1[Extract Share Configuration]
    C1 --> C2[Generate Federation Runtime Call]
    C2 --> C3[Add Tree-Shaking Metadata]
    C3 --> C4[Apply Pure Annotations]
    
    D --> D1[Generate Standard Require]
    D1 --> D2[Apply Module Resolution]
    D2 --> D3[Generate Webpack Require Call]
    
    C4 --> E[Runtime Code Generation]
    D3 --> E
    
    E --> F{Template Type}
    F -->|ConsumeShared| G[Federation-Aware Code]
    F -->|Standard| H[Standard Webpack Code]
    
    G --> I["var module = __webpack_require__.consumeShared('default', 'lodash', fallback);"]
    H --> J["var module = __webpack_require__('lodash');"]
    
    style C fill:#e1f5fe
    style D fill:#fff3e0
    style G fill:#e8f5e8
    style H fill:#ffebee
```

### Runtime Integration Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMMONJS RUNTIME INTEGRATION                  â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                Standard CommonJS Runtime                    â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  Generated Code:                                            â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ // Standard require() call                      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var lodash = __webpack_require__("lodash");     â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // Direct module loading                        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // No federation features                       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // No sharing or version resolution             â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚             Enhanced CommonJS Runtime (Future)              â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  ConsumeShared Integration:                                 â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ // ConsumeShared-aware require()                â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var lodash = (function() {                      â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   try {                                         â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     // Try shared scope first                   â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     return __webpack_require__.consumeShared(   â”‚   â”‚ â”‚
â”‚ â”‚     â”‚       "default", "lodash", "^4.17.0"           â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     );                                          â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   } catch (e) {                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     // Fallback to local module                â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     return __webpack_require__("lodash");       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   }                                             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ })();                                           â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  Tree-Shaking Integration:                                  â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ // Pure annotation for tree-shaking             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ /* #__PURE__ */ var lodash =                    â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   __webpack_require__.consumeShared(            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     "default", "lodash", fallback               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   );                                            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚                                                 â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ // Export usage tracking                        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ var { debounce } = lodash;  // Track usage      â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              Runtime Loader Integration                     â”‚ â”‚
â”‚ â”‚                                                             â”‚ â”‚
â”‚ â”‚  ConsumeShared Runtime Module Extensions:                   â”‚ â”‚
â”‚ â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚     â”‚ __webpack_require__.consumeSharedCommonJS = {   â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   load: function(shareScope, shareKey, version) â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     // CommonJS-specific loading logic          â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     var shared = getSharedScope(shareScope);    â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     if (shared[shareKey]) {                     â”‚   â”‚ â”‚
â”‚ â”‚     â”‚       return shared[shareKey].get();            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     }                                           â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     throw new Error("Shared not found");        â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   },                                            â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   loadWithFallback: function(scope, key, fb) {  â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     try {                                       â”‚   â”‚ â”‚
â”‚ â”‚     â”‚       return this.load(scope, key);             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     } catch (e) {                               â”‚   â”‚ â”‚
â”‚ â”‚     â”‚       return fb();                              â”‚   â”‚ â”‚
â”‚ â”‚     â”‚     }                                           â”‚   â”‚ â”‚
â”‚ â”‚     â”‚   }                                             â”‚   â”‚ â”‚
â”‚ â”‚     â”‚ };                                              â”‚   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

This document provides CommonJS-specific visual diagrams that complement the existing Module Federation documentation. The diagrams illustrate:

### Key Insights

1. **Current Limitations**: CommonJS modules have limited ConsumeShared integration compared to ESM modules
2. **Detection Challenges**: ConsumeShared context detection for CommonJS requires enhanced parent module and connection analysis
3. **Template Differences**: CommonJS and ESM use different code generation templates with varying federation support levels
4. **Runtime Integration**: Future enhancements will require specialized CommonJS runtime integration with the ConsumeShared system

### Implementation Status

- âœ… **Completed**: Basic CommonJS dependency detection and template generation
- ğŸ”„ **In Progress**: Enhanced ConsumeShared detection with debugging support
- â³ **Planned**: Full ConsumeShared integration, tree-shaking support, and runtime enhancements

### Technical Architecture

The diagrams show how CommonJS modules interact with the Module Federation system at different levels:
- **Dependency Level**: How `require()` calls are parsed and processed
- **Template Level**: How code generation differs between standard and ConsumeShared contexts
- **Runtime Level**: How the generated code integrates with the Module Federation runtime system

These visual flows provide a comprehensive understanding of CommonJS module handling within the Rspack Module Federation ecosystem, highlighting both current capabilities and future enhancement opportunities.