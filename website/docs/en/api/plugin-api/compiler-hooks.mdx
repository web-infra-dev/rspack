import CompilerType from '../../types/compiler.mdx';
import CompilationType from '../../types/compilation.mdx';
import StatsType from '../../types/stats.mdx';
import { Collapse, CollapsePanel } from '@components/Collapse';
import { ApiMeta } from '@components/ApiMeta';
import Columns from '@components/Columns';

# Compiler Hooks

## Overview

<Columns titles={["rspack()", "compiler.run()", "compiler.compile()"]}>
<>
```mermaid
flowchart TD
  CallRspack("rspack()") --> CreateCompiler("new Compiler()")
  CreateCompiler --> ApplyNodeEnvPlugin(Apply NodeEnvironmentPlugin)
  ApplyNodeEnvPlugin --> ApplyDefaultOptions(Apply default options)
  ApplyDefaultOptions --> ApplyCustomPlugins(Apply custom plugins)
  ApplyCustomPlugins --> HookEnvironment(hooks.environment)
  HookEnvironment --> HookAfterEnvironment(hooks.afterEnvironment)
  HookAfterEnvironment --> ApplyRspackPlugins(Apply internal plugins)
  ApplyRspackPlugins <--> HookEntryOptions(hooks.entryOptions)
  ApplyRspackPlugins --> HookAfterPlugins(hooks.afterPlugins)
  HookAfterPlugins --> ResolveOptions(resolverFactory.hooks.resolveOptions)
  ResolveOptions --> HookAfterResolvers(hooks.afterResolvers)
  HookAfterResolvers --> HookInitialize(hooks.initialize)
  HookInitialize --> compiler

class CallRspack flow-start
class compiler flow-end
class ApplyNodeEnvPlugin,ApplyDefaultOptions,ApplyCustomPlugins,ApplyRspackPlugins,ResolveOptions flow-process
class HookEnvironment,HookAfterEnvironment,HookEntryOptions,HookAfterPlugins,HookAfterResolvers,HookInitialize flow-hook

````
</>

<>
```mermaid
flowchart TD
  RunCompiler("compiler.run(callback)") --> HookBeforeRun(hooks.beforeRun)
  HookBeforeRun --> HooksRun(hooks.run)
  HooksRun --> HooksReadRecords(hooks.readRecords)
  HooksReadRecords --> Compile("compiler.compile()")
  Compile --> HookShouldEmit{hooks.shouldEmit}
  HookShouldEmit --> |true| HookEmit(hooks.emit)
  HookShouldEmit --> |false| HookDone(hooks.done)
  HookEmit --> EmitAssets(Emit asset files)
  EmitAssets <--> HookAssetEmitted(hooks.assetEmitted)
  EmitAssets --> HookAfterEmit(hooks.afterEmit)
  HookAfterEmit --> HookNeedAdditionalPass{hooks.needAdditionalPass}
  HookNeedAdditionalPass --> |true| HookAdditionalDone(hooks.done)
  HookAdditionalDone --> HookAdditionPass(hooks.additionalPass)
  HookAdditionPass --> Compile
  HookNeedAdditionalPass --> |false| HookEmitRecords(hooks.emitRecords)
  HookEmitRecords --> HookDone
  HookDone --> HookFailed(hooks.failed)
  HookFailed --> Callback("callback(err, stats)")
  Callback --> HookAfterDone(hooks.afterDone)
````

</>

<>
```mermaid
flowchart TD
  Compile("compiler.compile(callback)") --> CompilationParams("Create module factories")
  CompilationParams --> HookNormalModuleFactory(hooks.normalModuleFactory)
  CompilationParams --> HookContextModuleFactory(hooks.contextModuleFactory)
  CompilationParams --> HookBeforeCompile(hooks.beforeCompile)
  HookBeforeCompile --> HookCompile(hooks.compile)
  HookCompile --> Compilation("new Compilation")
  Compilation --> HookThisCompilation(hooks.thisCompilation)
  HookThisCompilation --> HookCompilation(hooks.compilation)
  HookCompilation --> HookMake(hooks.make)
  HookMake --> CreateModuleGraph(Create module graph)
  CreateModuleGraph <--> RunLoaders(Run loaders on modules)
  CreateModuleGraph --> HookFinishMake(hooks.finishMake)
  HookFinishMake --> CompilationFinish("compilation.finish()")
  CompilationFinish --> CompilationSeal("compilation.seal()")
  CompilationSeal --> HookAfterCompile(hooks.afterCompile)
  HookAfterCompile --> Callback("callback()")
```
</>

</Columns>

## `environment`

Called while preparing the compiler environment, right after initializing the plugins in the configuration file.

- **Type:** `SyncHook<[]>`

## `afterEnvironment`

Called right after the `environment` hook, when the compiler environment setup is complete.

- **Type:** `SyncHook<[]>`

## `entryOption`

Called after the [`entry`](/config/entry) configuration from Rspack options has been processed.

- **Type:** `SyncBailHook<[string, EntryNormalized]>`
- **Arguments:**
  - `string`: same with [`context`](/config/context)
  - `EntryNormalized`: normalized [`entry`](/config/entry)

## `afterPlugins`

Called after setting up initial set of internal plugins.

- **Type:** `SyncHook<[Compiler]>`
- **Arguments:**
  - `Compiler`: current compiler instance

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compiler.ts"
    key="Compiler"
  >
    <CompilerType />
  </CollapsePanel>
</Collapse>

## `afterResolvers`

Triggered after resolver setup is complete.

- **Type:** `SyncHook<[Compiler]>`
- **Arguments:**
  - `Compiler`: current compiler instance

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compiler.ts"
    key="Compiler"
  >
    <CompilerType />
  </CollapsePanel>
</Collapse>

## `initialize`

Called when a compiler object is initialized.

- **Type:** `SyncHook<[]>`

## `beforeRun`

Adds a hook right before running the compiler.

- **Type:** `AsyncSeriesHook<[Compiler]>`
- **Arguments:**
  - `Compiler`: current compiler instance

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compiler.ts"
    key="Compiler"
  >
    <CompilerType />
  </CollapsePanel>
</Collapse>

## `run`

Called ad the beginning of a build execution.

- **Type:** `AsyncSeriesHook<[Compiler]>`
- **Arguments:**
  - `Compiler`: current compiler instance

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compiler.ts"
    key="Compiler"
  >
    <CompilerType />
  </CollapsePanel>
</Collapse>

## `watchRun`

Executes a plugin during watch mode after a new compilation is triggered but before the compilation is actually started.

- **Type:** `AsyncSeriesHook<[Compiler]>`
- **Arguments:**
  - `Compiler`: current compiler instance

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compiler.ts"
    key="Compiler"
  >
    <CompilerType />
  </CollapsePanel>
</Collapse>

## `beforeCompile`

Executes a plugin after compilation parameters are created.

- **Type:** `AsyncSeriesHook<[]>`

## `compile`

Called right after `beforeCompile`, before a new compilation is created.

- **Type:** `SyncHook<[]>`

## `thisCompilation`

Called while initializing the compilation, right before calling the `compilation` hook.

- **Type:** `SyncHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: created [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `compilation`

Runs a plugin after a compilation has been created.

- **Type:** `SyncHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: created [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `make`

Called before the make phase.

In the make phase, Rspack will build the module graph starting from the entry, and use the loader to handle each module.

- **Type:** `AsyncParallelHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: current [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `afterCompile`

Called after the make phase and before the seal phase.

In the seal phase, Rspack will create chunk graph from the module graph and then generate the assets.

- **Type:** `AsyncSeriesHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: current [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `shouldEmit`

<ApiMeta addedVersion="0.4.1" />

Called before emitting assets. Should return a boolean telling whether to emit.

- **Type:** `SyncBailHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: current [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `emit`

Called right before emitting assets to output dir.

- **Type:** `AsyncSeriesHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: current [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `afterEmit`

Called after emitting assets to output directory.

- **Type:** `AsyncSeriesHook<[Compilation]>`
- **Arguments:**
  - `Compilation`: current [compilation](/api/javascript-api/compilation) object

<Collapse>
  <CollapsePanel
    className="collapse-code-panel"
    header="Compilation.ts"
    key="Compilation"
  >
    <CompilationType />
  </CollapsePanel>
</Collapse>

## `done`

Called when the compilation has completed.

- **Type:** `AsyncSeriesHook<Stats>`
- **Arguments:**
  - `Stats`: generated stats object

<Collapse>
  <CollapsePanel className="collapse-code-panel" header="Stats.ts" key="Stats">
    <StatsType />
  </CollapsePanel>
</Collapse>

## `afterDone`

Called after `done` hook.

- **Type:** `SyncHook<Stats>`
- **Arguments:**
  - `Stats`: generated stats object

<Collapse>
  <CollapsePanel className="collapse-code-panel" header="Stats.ts" key="Stats">
    <StatsType />
  </CollapsePanel>
</Collapse>

## `failed`

Called if the compilation fails.

- **Type:** `SyncHook<[Error]>`

## `watchClose`

Called when a watching compilation has stopped.

- **Type:** `SyncHook<[]>`
