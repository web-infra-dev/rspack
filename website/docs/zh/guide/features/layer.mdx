# Layer

Layer 是 Rspack 提供的一个强大特性，允许你对模块进行分类管理。通过为模块分配不同的 layer，你可以针对不同类型的模块执行差异化处理，比如：

- 根据不同的 layer 使用不同的编译目标
- 将不同 layer 的模块拆分到不同的输出目录
- 为不同环境（如服务端和客户端）的代码应用不同的优化策略

## 指定 Layer 的方式

你可以通过以下几种方式为模块指定 layer：

### 1. 通过 Entry 指定

在入口配置中直接为不同的入口点指定 layer：

```js
export default {
  entry: {
    server: {
      import: './src/server.js',
      layer: 'server',
    },
    client: {
      import: './src/client.js',
      layer: 'client',
    },
  },
};
```

### 2. 通过 Loader 规则指定

你可以使用 `rule.layer` 选项为所有匹配规则的模块指定 layer：

```js
export default {
  module: {
    rules: [
      {
        test: /\.js$/,
        layer: 'yourLayer',
      },
    ],
  },
};
```

## 给不同的 Layer 应用不同的处理规则

你可以使用 `issuerLayer` 来筛选特定 layer 的模块，并为它们应用不同的处理规则。以下示例展示了如何为不同 layer 使用不同的编译目标：

```js
export default {
  module: {
    rules: [
      {
        test: /\.js$/,
        oneOf: [
          {
            issuerLayer: 'client',
            use: [
              {
                loader: 'builtin:swc-loader',
                options: {
                  jsc: {
                    target: 'es5',
                  },
                },
              },
            ],
          },
          {
            issuerLayer: 'server',
            use: [
              {
                loader: 'builtin:swc-loader',
                options: {
                  jsc: {
                    target: 'es2020',
                  },
                },
              },
            ],
          },
        ],
      },
    ],
  },
};
```

## 基于 Layer 的代码分割

在构建优化阶段，你可以根据不同的 layer 将模块分配到不同的 chunk 中：

```js
export default {
  optimization: {
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        server: {
          layer: 'server',
          filename: 'server/[name].js',
        },
        client: {
          layer: 'client',
          filename: 'client/[name].js',
        },
      },
    },
  },
};
```

通过上述配置，我们成功地将 server 和 client 代码分别输出到了不同的目录中，实现了基于 layer 的代码分离。
