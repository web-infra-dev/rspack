# 从 Rspack 1.x 迁移

当前文档列出了从 Rspack v1.x 到 v2.0 的所有不兼容更新，你可以参考此文档来迁移。

> 查看 [Breaking changes in Rspack v2.0](https://github.com/web-infra-dev/rspack/discussions/9270) 了解更多细节。

## 前置准备

### Node.js 版本要求

Rspack 2.0 将最低 Node.js 版本从 16.x 升级到 **18.12.0**。

在升级之前，请确保你的 Node.js 版本满足要求：

```bash
node -v
# 应该输出 v18.12.0 或更高版本
```

### 依赖更新

如果你使用 `@rspack/dev-server`，现在它变为可选的 peer dependency。使用 `rspack serve` 或 `rspack preview` 命令时需要手动安装：

```bash
pnpm add -D @rspack/dev-server
# 或
npm install --save-dev @rspack/dev-server
# 或
yarn add -D @rspack/dev-server
```

## 配置项默认值调整

在 Rspack 2.0 中，我们调整了多个配置项的默认值。

### [重要] 移除 experiments.css

`experiments.css` 配置已被移除，CSS 处理能力现在默认可用。

在 Rspack 1.x 中，你需要设置 `experiments.css: true` 来启用 CSS 处理能力。

在 Rspack 2.0 中，CSS 处理能力默认可用，但你仍需要在 `module.rules` 中显式配置来处理 CSS 文件：

```js title="rspack.config.mjs"
export default {
  module: {
    rules: [
      {
        test: /\.css$/,
        type: 'css/auto', // 自动识别 CSS Modules
      },
    ],
  },
};
```

#### CSS 类型说明

- **`css`**：将 CSS 作为纯 CSS 处理，不启用 CSS Modules
- **`css/module`**：强制启用 CSS Modules
- **`css/auto`**：自动检测，对于 `.module.css` 文件启用 CSS Modules，普通 `.css` 文件则作为纯 CSS 处理

### [重要] WebAssembly 支持默认启用

[experiments.asyncWebAssembly](/config/experiments#experimentsasyncwebassembly) 的默认值从 `false` 调整为 `true`。

在 Rspack 2.0 中，异步 WebAssembly 支持默认启用，允许使用 `type: 'webassembly/async'`。

使用示例：

```js title="rspack.config.mjs"
export default {
  module: {
    rules: [
      {
        test: /\.wasm$/,
        type: 'webassembly/async',
      },
    ],
  },
};
```

如果你不需要此功能，可以显式禁用：

```js title="rspack.config.mjs"
export default {
  experiments: {
    asyncWebAssembly: false,
  },
};
```

### 全局变量名称变更

为了更好地标识 Rspack，我们将默认的全局变量名称和默认值从 `webpack` 前缀改为 `rspack` 前缀。

#### output.chunkLoadingGlobal

[output.chunkLoadingGlobal](/config/output#outputchunkloadingglobal) 的默认值从 `webpackChunk${output.uniqueName}` 改为 `rspackChunk${output.uniqueName}`。

如果你的应用依赖特定的全局变量名称（例如在 HTML 中直接引用），需要显式配置：

```js title="rspack.config.mjs"
export default {
  output: {
    chunkLoadingGlobal: 'webpackChunkMyApp',
  },
};
```

#### output.hotUpdateGlobal

[output.hotUpdateGlobal](/config/output#outputhotupdateglobal) 的默认值从 `webpackHotUpdate${output.uniqueName}` 改为 `rspackHotUpdate${output.uniqueName}`。

#### output.trustedTypes.policyName

[output.trustedTypes.policyName](/config/output#outputtrustedtypespolicyname) 的打底值从 `'webpack'` 改为 `'rspack'`。

`policyName` 的默认值为 `output.uniqueName`，只有在未设置 `uniqueName` 时才会使用打底值。

如果你的项目未设置 `uniqueName` 并依赖特定的 Trusted Types 策略名称，需要更新你的 CSP 配置或显式设置：

```js title="rspack.config.mjs"
export default {
  output: {
    trustedTypes: {
      policyName: 'webpack',
    },
  },
};
```

### Loader 和 Plugin 的 target 派生

在 Rspack 2.0 中，loader 和 plugin 的 `target` 配置现在默认从 [target](/config/target) 配置派生。

这会影响 `builtin:swc-loader` 等内置 loader 的行为。例如，当 `target: 'node'` 时，`builtin:swc-loader` 会自动使用适合 Node.js 环境的配置。

如果你需要显式控制 loader 的 target，可以在 loader 选项中配置：

```js title="rspack.config.mjs"
export default {
  target: 'node',
  module: {
    rules: [
      {
        test: /\.js$/,
        loader: 'builtin:swc-loader',
        options: {
          env: {
            targets: 'chrome >= 87',
          },
        },
      },
    ],
  },
};
```

### Stats.toJson() 默认值

`stats.toJson()` 方法在未传入参数时，以下字段的默认值调整为 `false`：

- `modules` - 模块信息
- `assets` - 资源信息
- `chunks` - chunk 信息
- `chunkGroups` - chunk group 信息
- `entryPoints` - 入口点信息

这意味着调用 `stats.toJson()` 时，默认不再包含这些详细信息，返回的对象更加精简。

如果你需要获取详细信息，可以在调用 `toJson()` 时显式传入参数：

```js
const statsData = stats.toJson({
  modules: true,
  assets: true,
  chunks: true,
  chunkGroups: true,
  entryPoints: true,
});
```

### Parser 默认行为

#### require 表达式

`parser.javascript.requireAsExpression` 的默认值调整为 `false`。

这意味着 `require` 不再被视为表达式进行解析，某些动态用法可能不再工作。如需启用，请显式配置：

```js title="rspack.config.mjs"
export default {
  module: {
    parser: {
      javascript: {
        requireAsExpression: true,
      },
    },
  },
};
```

#### require 重命名

默认禁用 require 重命名解析功能。

如果你的代码中使用了类似 `const req = require; req('./module')` 的模式，可能需要显式启用：

```js title="rspack.config.mjs"
export default {
  module: {
    parser: {
      javascript: {
        requireAlias: true,
      },
    },
  },
};
```

## 配置项移动和重组

### [重要] experiments.cache 移动到 cache

`experiments.cache` 配置已移动到顶层的 [cache](/config/cache) 配置。

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    cache: {
-      type: 'filesystem',
-      buildDependencies: {
-        config: [__filename],
-      },
-    },
-  },
+  cache: {
+    type: 'filesystem',
+    buildDependencies: {
+      config: [__filename],
+    },
+  },
};
```

### [重要] experiments.rspackFuture 移除，bundlerInfo 移动到 output

`experiments.rspackFuture` 配置已被移除，其中的 `bundlerInfo` 选项移动到 [output.bundlerInfo](/config/output#outputbundlerinfo)。

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    rspackFuture: {
-      bundlerInfo: {
-        version: '1.0.0',
-      },
-    },
-  },
+  output: {
+    bundlerInfo: {
+      version: '1.0.0',
+    },
+  },
};
```

### experiments.incremental 移动到 incremental

`experiments.incremental` 配置已移动到顶层的 [incremental](/config/incremental) 配置。

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    incremental: {
-      make: true,
-      emitAssets: true,
-    },
-  },
+  incremental: {
+    make: true,
+    emitAssets: true,
+  },
};
```

## 移除的配置项

### 移除的 experiments 配置

#### experiments.layers

Layer 功能已稳定并默认启用，`experiments.layers` 配置项已被移除。

如果你之前显式启用了该功能：

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    layers: true,
-  },
};
```

现在可以直接移除该配置，Layer 功能将自动可用。

使用示例：

```js title="rspack.config.mjs"
export default {
  module: {
    rules: [
      {
        test: /\.css$/,
        type: 'css/auto',
        layer: 'styles', // 将 CSS 模块放入 'styles' layer
      },
      {
        test: /\.js$/,
        layer: 'app', // 将 JS 模块放入 'app' layer
      },
    ],
  },
};
```

#### experiments.topLevelAwait

Top-level await 功能已稳定并默认启用，`experiments.topLevelAwait` 配置项已被移除。

如果你之前显式启用了该功能：

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    topLevelAwait: true,
-  },
};
```

现在可以直接移除该配置，在 ESM 模块中使用 top-level await 将自动工作。

使用示例：

```js title="config.mjs"
// 在模块顶层直接使用 await
const response = await fetch('https://api.example.com/config');
const config = await response.json();

export default config;
```

```js title="index.js"
// 导入使用了 top-level await 的模块
import config from './config.mjs';

console.log(config);
```

#### experiments.lazyCompilation

`experiments.lazyCompilation` 配置项已被移除，懒编译配置已移动到根配置的 [lazyCompilation](/config/lazy-compilation)。

迁移示例：

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    lazyCompilation: true,
-  },
+  lazyCompilation: true,
};
```

或者使用对象配置：

```js title="rspack.config.mjs"
export default {
  lazyCompilation: {
    entries: true,
    imports: true,
  },
};
```

详细配置选项请参考 [lazy compilation 文档](/config/lazy-compilation)。

#### experiments.lazyBarrel

`experiments.lazyBarrel` 配置项已被移除，因为该优化已默认启用。

如果你之前显式启用了该功能：

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    lazyBarrel: true,
-  },
};
```

现在可以直接移除该配置，barrel 文件的懒加载优化将自动生效。

#### experiments.typeReexportsPresence

`experiments.typeReexportsPresence` 实验性功能已被移除。

类型重导出的处理现在由默认行为控制，无需额外配置：

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    typeReexportsPresence: true,
-  },
};
```

#### experiments.parallelLoader

`experiments.parallelLoader` 实验性功能已被移除。

Loader 的并行处理功能已稳定，不再需要通过 `experiments` 启用。如果需要让 loader 并行执行，直接在 loader 配置中添加 `parallel: true` 即可：

```diff title="rspack.config.mjs"
export default {
-  experiments: {
-    parallelLoader: true,
-  },
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          {
            loader: './my-loader.js',
+           parallel: true,
            options: {},
          },
        ],
      },
    ],
  },
};
```

#### experiments.SubResourceIntegrityPlugin

`experiments.SubResourceIntegrityPlugin` 配置已被移除，该插件已移动到根配置作为独立插件 `SubresourceIntegrityPlugin`。

迁移示例：

```diff title="rspack.config.mjs"
+ import { SubresourceIntegrityPlugin } from '@rspack/core';
+
export default {
+  output: {
+    crossOriginLoading: 'anonymous',
+  },
-  experiments: {
-    SubResourceIntegrityPlugin: true,
-  },
+  plugins: [
+    new SubresourceIntegrityPlugin({
+      hashFuncNames: ['sha384'],
+    }),
+  ],
};
```

详细配置选项请参考 [SubresourceIntegrityPlugin 文档](/plugins/rspack/subresource-integrity-plugin)。

### 移除的 output 配置

#### output.charset

`output.charset` 配置已被移除。

该选项用于在生成的 `<script>` 标签中添加 `charset` 属性，但现代浏览器已默认使用 UTF-8 编码，不再需要此属性。

如果你之前设置了该配置：

```diff title="rspack.config.mjs"
export default {
  output: {
-    charset: true,
  },
};
```

现在可以直接移除，浏览器会自动使用 UTF-8 编码。

### 移除的 stats 和 profile 配置

#### profile 和 stats.profile

顶层的 `profile` 配置和 `stats.profile` 配置已被移除。

这些选项用于在构建过程中收集性能分析数据，但其功能有限且输出不够直观。

如果你之前启用了这些配置：

```diff title="rspack.config.mjs"
export default {
-  profile: true,
  stats: {
-    profile: true,
  },
};
```

建议使用更专业的性能分析工具：

- [Rsdoctor](/guide/optimization/use-rsdoctor) - Rspack 官方推荐的性能分析工具，提供可视化界面和详细的性能报告
- Chrome DevTools Performance 面板 - 分析运行时性能
- Node.js 内置 profiler - 使用 `--prof` 和 `--prof-process` 分析 Node.js 层面的性能

## builtin:swc-loader 的调整

### verbatimModuleSyntax 默认启用

`builtin:swc-loader` 的 `verbatimModuleSyntax` 选项默认值从 `false` 调整为 `true`。

这会影响类型导入/导出的行为。TypeScript 会保留导入/导出语句的原始语法，不会进行额外的转换。

如果你需要旧的行为，可以显式设置为 `false`：

```js title="rspack.config.mjs"
export default {
  module: {
    rules: [
      {
        test: /\.ts$/,
        loader: 'builtin:swc-loader',
        options: {
          jsc: {
            parser: {
              syntax: 'typescript',
            },
            transform: {
              verbatimModuleSyntax: false,
            },
          },
        },
      },
    ],
  },
};
```


### 禁用 .swcrc 读取

JavaScript 编译器中默认禁用 `.swcrc` 文件读取。

在 Rspack 1.x 中，如果项目根目录存在 `.swcrc` 文件，会自动读取并应用配置。

在 Rspack 2.0 中，`.swcrc` 文件不再自动读取。你需要将 SWC 配置迁移到 `rspack.config.js` 的 loader 选项中：

```js title="rspack.config.mjs"
export default {
  module: {
    rules: [
      {
        test: /\.js$/,
        loader: 'builtin:swc-loader',
        options: {
          jsc: {
            parser: {
              syntax: 'ecmascript',
              jsx: true,
            },
            transform: {
              react: {
                runtime: 'automatic',
              },
            },
          },
        },
      },
    ],
  },
};
```

## 插件相关变更

### EsmLibraryPlugin 不再直接暴露

`rspack.EsmLibraryPlugin` 不再作为公共 API 暴露。

如果你之前使用 `EsmLibraryPlugin`，现在应该使用配置方式：

```diff title="rspack.config.mjs"
-import { EsmLibraryPlugin } from '@rspack/core';
-
export default {
-  plugins: [new EsmLibraryPlugin()],
+  output: {
+    library: {
+      type: 'modern-module',
+    },
+  },
};
```

### 移除的插件

#### WarnCaseSensitiveModulesPlugin

`WarnCaseSensitiveModulesPlugin` 插件已被移除。

如果你需要检测大小写敏感的模块引用问题，请使用 `CaseSensitivePlugin` 替代：

```diff title="rspack.config.mjs"
+ import { rspack } from '@rspack/core';
+
export default {
  plugins: [
-    new rspack.WarnCaseSensitiveModulesPlugin(),
+    new rspack.CaseSensitivePlugin(),
  ],
};
```

详细配置选项请参考 [CaseSensitivePlugin 文档](/plugins/webpack/case-sensitive-plugin)。

### 移除的插件方法

#### 插件的 getHooks 方法

插件的 `getHooks` 方法已被移除，请使用 `getCompilationHooks` 替代。

迁移示例：

```diff title="my-plugin.js"
class MyPlugin {
  apply(compiler) {
    compiler.hooks.compilation.tap('MyPlugin', (compilation) => {
-      const hooks = compiler.HtmlRspackPlugin.getHooks(compilation);
+      const hooks = compiler.HtmlRspackPlugin.getCompilationHooks(compilation);
      
      hooks.beforeEmit.tap('MyPlugin', (data, cb) => {
        // ...
      });
    });
  }
}
```

### HtmlRspackPlugin 调整

[HtmlRspackPlugin](/plugins/rspack/html-rspack-plugin) 的以下选项已被移除：

- **`sri`** - SRI (Subresource Integrity) 选项已被移除

如果你需要 SRI 功能，可以考虑使用其他方案或自定义插件。

### LightningCssMinimizerRspackPlugin 调整

[LightningCssMinimizerRspackPlugin](/plugins/rspack/lightning-css-minimizer-rspack-plugin) 的以下选项已被移除或重命名：

#### draft 选项

`draft` 选项已被移除，请使用 `drafts` 替代。

迁移示例：

```diff title="rspack.config.mjs"
import { LightningCssMinimizerRspackPlugin } from '@rspack/core';

export default {
  optimization: {
    minimizer: [
      new LightningCssMinimizerRspackPlugin({
-       draft: {
-         customMedia: true,
-       },
+       drafts: {
+         customMedia: true,
+       },
      }),
    ],
  },
};
```

#### cssHeadDataCompression 选项

`cssHeadDataCompression` 选项已被移除，因为该选项未被实际使用。

如果你之前配置了该选项：

```diff title="rspack.config.mjs"
import { LightningCssMinimizerRspackPlugin } from '@rspack/core';

export default {
  optimization: {
    minimizer: [
      new LightningCssMinimizerRspackPlugin({
-       cssHeadDataCompression: true,
      }),
    ],
  },
};
```

可以直接移除该配置，不会影响构建结果。

### Runtime Module 废弃属性

Runtime module 的以下废弃属性已被移除：

- `constructorName` - 构造函数名称属性
- `moduleIdentifier` - 模块标识符属性

如果你在自定义插件中使用了这些属性，需要更新代码：

```diff title="my-plugin.js"
class MyPlugin {
  apply(compiler) {
    compiler.hooks.compilation.tap('MyPlugin', (compilation) => {
      compilation.hooks.runtimeModule.tap('MyPlugin', (module) => {
-       const name = module.constructorName;
-       const id = module.moduleIdentifier;
+       // 使用其他方式获取模块信息
+       const name = module.constructor.name;
+       const id = module.identifier();
      });
    });
  }
}
```