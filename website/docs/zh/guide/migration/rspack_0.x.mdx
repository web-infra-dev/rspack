# ä» Rspack 0.x è¿ç§»

å½“å‰æ–‡æ¡£åˆ—å‡ºäº†ä» Rspack v0.7 åˆ° v1.0 çš„æ‰€æœ‰ä¸å…¼å®¹æ›´æ–°ï¼Œä½ å¯ä»¥å‚è€ƒæ­¤æ–‡æ¡£æ¥è¿ç§»ã€‚

> æŸ¥çœ‹ [Breaking changes in Rspack v1.0.0](https://github.com/web-infra-dev/rspack/discussions/6626) äº†è§£æ›´å¤šç»†èŠ‚ã€‚

## é…ç½®é¡¹é»˜è®¤å€¼è°ƒæ•´

åœ¨ Rspack 1.x ä¸­ï¼Œæˆ‘ä»¬å¯¹é½äº† webpack çš„é…ç½®é¡¹é»˜è®¤å€¼ã€‚

### [é‡è¦] experiments.css

[experiments.css](/config/experiments#experimentscss) çš„é»˜è®¤å€¼ä» `true` è°ƒæ•´ä¸º `false`ã€‚

åœ¨ Rspack 0.x ä¸­ï¼Œ`experiments.css` é»˜è®¤å¼€å¯ï¼Œè¿™æ„å‘³ç€ä»¥ `*.css` ç»“å°¾çš„æ–‡ä»¶ä¼šé»˜è®¤è¢«è§†ä¸º `type: 'css/auto'`ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¼•å…¥å…¶ä»– loader æ¥å¤„ç† CSS æ–‡ä»¶ã€‚

å¦‚æœä½ ä¾èµ–å†…ç½®åŠŸèƒ½æ¥å¤„ç† CSS æ–‡ä»¶è€Œä¸ä½¿ç”¨ä»»ä½• loaderï¼Œæˆ–è€…ä½¿ç”¨äº†å¦‚ä¸‹çš„é…ç½®æ¥å¤„ç† CSS æ–‡ä»¶ï¼š

```js title="rspack.config.mjs"
export default {
  module: {
    rules: [
      {
        test: /\.less$/,
        type: 'css/auto', // ğŸ‘ˆ
        use: ['less-loader'],
      },
    ],
  },
};
```

è¯·æ³¨æ„ï¼Œä½ ç°åœ¨éœ€è¦æ‰‹åŠ¨å¯ç”¨ `experiments.css`ã€‚

### [é‡è¦] optimization.concatenateModules

[optimization.concatenateModules](/config/optimization#optimizationconcatenatemodules) é»˜è®¤å€¼ç”± `false` è°ƒæ•´ä¸ºï¼š

- å½“ `mode` ä¸º `'production'` æ—¶ï¼Œé»˜è®¤ä¸º `true`ã€‚
- `mode` ä¸ºå…¶ä»–å€¼æ—¶ï¼Œé»˜è®¤å€¼ä¸º `false`ã€‚

åœ¨ Rspack 1.x ä¸­ï¼Œæ¨¡å—æ‹¼æ¥ä¼˜åŒ–å˜å¾—æ›´åŠ ç¨³å®šã€‚ç°åœ¨ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é»˜è®¤å¼€å¯è¯¥ä¼˜åŒ–ï¼Œä»¥å…è®¸å°†å¤šä¸ªæ¨¡å—æ‹¼æ¥æˆå•ä¸ªæ¨¡å—ä»¥é™ä½äº§ç‰©ä½“ç§¯ï¼Œæå‡å‹ç¼©æ•ˆç‡ã€‚

### devtool

[devtool](/config/devtool) é»˜è®¤å€¼ç”± `false` è°ƒæ•´ä¸ºï¼š

- å½“ `mode` ä¸º `'development'` æ—¶ï¼Œé»˜è®¤ä¸º `'eval'`ã€‚
- `mode` ä¸ºå…¶ä»–å€¼æ—¶ï¼Œé»˜è®¤å€¼ä¸º `false`ã€‚

> `@rspack/cli` ä¼šè¦†ç›– `@rspack/core` ä¸­ `devtool` çš„é»˜è®¤å€¼ï¼Œå› æ­¤å¦‚æœä½ ä½¿ç”¨ `@rspack/cli`ï¼Œæ­¤å˜æ›´ä¸å—å½±å“ã€‚

### experiments.asyncWebAssembly

[experiments.asyncWebAssembly](/config/experiments#experimentsasyncwebassembly) é»˜è®¤å€¼ä» `false` è°ƒæ•´ä¸ºä¾èµ– `experiments.futureDefaults` é…ç½®é¡¹ï¼Œå½“ `experiments.futureDefaults` ä¸º `true` æ—¶æ‰é»˜è®¤å¼€å¯ã€‚

å¦‚æœä½ ä½¿ç”¨ WebAssembly æ¨¡å—ä½œä¸ºå¼‚æ­¥æ¨¡å—ï¼Œç°åœ¨éœ€è¦æ‰‹åŠ¨å°† `experiments.asyncWebAssembly` è®¾ç½®ä¸º `true`ã€‚

### splitChunks.cacheGroups.\{cacheGroup\}.reuseExistingChunk

[splitChunks.cacheGroups.\{cacheGroup\}.reuseExistingChunk](/plugins/webpack/split-chunks-plugin#splitchunkscachegroupscachegroupreuseexistingchunk) é»˜è®¤å€¼ä» `true` è°ƒæ•´ä¸º `false`ã€‚

### optimization.moduleIds

å½“ `mode` ä¸º `none` æ—¶ï¼Œ[optimization.moduleIds](/config/optimization#optimizationmoduleids) é»˜è®¤å€¼è°ƒæ•´ä¸º `'natural'`ã€‚

### optimization.chunkIds

å½“ `mode` ä¸º `none` æ—¶ï¼Œ[optimization.chunkIds](/config/optimization#optimizationchunkids) é»˜è®¤å€¼è°ƒæ•´ä¸º `'natural'`ã€‚

## ç§»é™¤çš„é…ç½®é¡¹

### [é‡è¦] ç§»é™¤ resolve.tsConfigPath

è¯·ä½¿ç”¨ [resolve.tsConfig](/config/resolve#resolvetsconfig) ä»£æ›¿ã€‚

```diff
export default {
  resolve: {
-   tsConfigPath: path.resolve(__dirname, './tsconfig.json'),
+   tsConfig: path.resolve(__dirname, './tsconfig.json'),
  },
};
```

### output.amdContainer

è¯·ä½¿ç”¨ [output.library.amdContainer](/config/output#outputlibraryamdcontainer) ä»£æ›¿ã€‚

## builtin:swc-loader çš„è°ƒæ•´

Rspack 1.x ä¸ºäº†ç²¾ç®€æ ¸å¿ƒï¼Œå°†å†…ç½®çš„ SWC æ’ä»¶ç§»é™¤ï¼Œç°åœ¨ä½ éœ€è¦æ‰‹åŠ¨å¼•å…¥å®ƒä»¬ã€‚

### [é‡è¦] ç§»é™¤ rspackExperiments.styledComponents

ä½¿ç”¨ [@swc/plugin-styled-components](https://www.npmjs.com/package/@swc/plugin-styled-components) ä»£æ›¿ã€‚

```diff
export default {
  module: {
    rules: [
      {
        test: /\.jsx$/,
        loader: "builtin:swc-loader",
        options: {
-         rspackExperiments: {
-           styledComponents: true,
-         },
          jsc: {
+           experimental: {
+             plugins: [["@swc/plugin-styled-components", {}]],
+           },
          },
        },
      },
    ],
  },
};
```

### [é‡è¦] ç§»é™¤ rspackExperiments.emotion

ä½¿ç”¨ [@swc/plugin-emotion](https://www.npmjs.com/package/@swc/plugin-emotion) ä»£æ›¿ã€‚

```diff
export default {
  module: {
    rules: [
      {
        test: /\.jsx$/,
        loader: "builtin:swc-loader",
        options: {
-         rspackExperiments: {
-           emotion: true,
-         },
          jsc: {
+           experimental: {
+             plugins: [["@swc/plugin-emotion", {}]],
+           },
          },
        },
      },
    ],
  },
};
```

### [é‡è¦] ç§»é™¤ rspackExperiments.relay

ä½¿ç”¨ [@swc/plugin-relay](https://www.npmjs.com/package/@swc/plugin-relay) ä»£æ›¿ã€‚

```diff
export default {
  module: {
    rules: [
      {
        test: /\.jsx$/,
        loader: "builtin:swc-loader",
        options: {
-         rspackExperiments: {
-           relay: true,
-         },
          jsc: {
+           experimental: {
+             plugins: [["@swc/plugin-relay", {}]],
+           },
          },
        },
      },
    ],
  },
};
```

### [é‡è¦] ç§»é™¤ rspackExperiments.preact

ä½¿ç”¨ [@swc/plugin-prefresh](https://www.npmjs.com/package/@swc/plugin-prefresh) ä»£æ›¿ã€‚

```diff
export default {
  module: {
    rules: [
      {
        test: /\.jsx$/,
        loader: "builtin:swc-loader",
        options: {
-         rspackExperiments: {
-           preact: true,
-         },
          jsc: {
+           experimental: {
+             plugins: [["@swc/plugin-prefresh", {}]],
+           },
          },
        },
      },
    ],
  },
};
```

## å†…ç½®æ’ä»¶çš„è°ƒæ•´

### [é‡è¦] CSS å‹ç¼©æ’ä»¶çš„è°ƒæ•´

åœ¨ Rspack 0.x ä¸­æˆ‘ä»¬ä½¿ç”¨å†…ç½®çš„ `rspack.SwcCssMinimizerRspackPlugin` æ¥å‹ç¼© CSS ä»£ç ã€‚ç°åœ¨ï¼Œè¯¥æ’ä»¶å·²è¢«ç§»é™¤ï¼Œå¹¶æ”¹ç”¨ [rspack.LightningCssMinimizerRspackPlugin](/plugins/rspack/lightning-css-minimizer-rspack-plugin) æ›¿ä»£å®ƒã€‚

å¦‚æœä½ ä¹‹å‰æ‰‹åŠ¨æ³¨å†Œå¹¶é…ç½® `rspack.SwcCssMinimizerRspackPlugin`ï¼Œç°åœ¨éœ€è¦ä½¿ç”¨ `rspack.LightningCssMinimizerRspackPlugin`ï¼š

```diff
import { rspack } from '@rspack/core';

export default {
  optimization: {
    minimizer: [
-     new rspack.SwcCssMinimizerRspackPlugin({
+     new rspack.LightningCssMinimizerRspackPlugin({
        // é€‰é¡¹é…ç½®
      }),
    ],
  },
};
```

### rspack.SwcJsMinimizerRspackPlugin

è¿™æ˜¯ Rspack å†…ç½®å¹¶é»˜è®¤å¯ç”¨çš„ JS å‹ç¼©æ’ä»¶ã€‚æˆ‘ä»¬å·²å°†å…¶é…ç½®ä¸ [SWC çš„å‹ç¼©é…ç½®](https://swc.rs/docs/configuration/minification)å¯¹é½ï¼Œä¸å…¼å®¹çš„é…ç½®å¦‚ä¸‹ï¼š

- `minimizerOptions.passes`ï¼šç§»åŠ¨åˆ° `minimizerOptions.compress.passes`
- `minimizerOptions.dropConsole`ï¼šç§»åŠ¨åˆ° `minimizerOptions.compress.drop_console`
- `minimizerOptions.pureFuncs`ï¼šç§»åŠ¨åˆ° `minimizerOptions.compress.pure_funcs`
- `minimizerOptions.keepClassNames`ï¼šç§»åŠ¨åˆ° `minimizerOptions.mangle.keep_classnames`
- `minimizerOptions.keepFnNames`ï¼šç§»åŠ¨åˆ° `minimizerOptions.mangle.keep_fnames`
- `minimizerOptions.comments`ï¼šç§»åŠ¨åˆ° `minimizerOptions.format.comments`
- `minimizerOptions.asciiOnly`ï¼šç§»åŠ¨åˆ° `minimizerOptions.format.ascii_only`

é»˜è®¤å€¼çš„å˜åŒ–ï¼š

- `comments` (`options.format.comments`)ï¼šé»˜è®¤å€¼ä» `false` æ”¹ä¸º `"some"`

### rspack.HtmlRspackPlugin

æˆ‘ä»¬å°†å…¶é…ç½®ä¸ [html-webpack-plugin](https://www.npmjs.com/package/html-webpack-plugin) å¯¹é½ï¼Œä¸å…¼å®¹çš„é…ç½®å¦‚ä¸‹ï¼š

- `excludedChunks` æ›´åä¸º `excludeChunks`
- å½“ `mode` ä¸º `'production'` æ—¶ï¼Œ`minify` é»˜è®¤ä¸º `true`

## å…¶ä»–

### [é‡è¦] @rspack/cli

`@rspack/cli` å·²å°†å…¶ä¾èµ–çš„ `webpack-dev-server` ä» v4 å‡çº§è‡³ v5ã€‚å¦‚æœä½ ä½¿ç”¨ `@rspack/cli`ï¼Œè¯·æ³¨æ„ä»¥ä¸‹ä¸å…¼å®¹çš„å˜æ›´ï¼š

- webpack-dev-server v5 æœ€ä½æ”¯æŒçš„ Node.js ç‰ˆæœ¬ä¸º 18.12.0ã€‚
- é…ç½®é€‰é¡¹å‘ç”Ÿäº†è‹¥å¹²å˜æ›´ï¼Œè¯·å‚é˜… [webpack-dev-server v5 çš„è¿ç§»æŒ‡å—](https://github.com/webpack/webpack-dev-server/blob/master/migration-v5.md)ã€‚

### [é‡è¦] `ResolverFactory` å’Œ `Resolver` ä½¿ç”¨ Rust é‡æ„

`ResolverFactory` å’Œ `Resolver` å·²è¢«ä½¿ç”¨ Rust è¿›è¡Œé‡æ„ï¼Œä»¥ç»Ÿä¸€ JS ä¾§å’Œ Rust ä¾§çš„å®ç°ã€‚ç”±äºè¿™ä¸€å˜æ›´ï¼Œç›®å‰ ResolverFactory å’Œ Resolver å¹¶ä¸æ”¯æŒä»»ä½•é’©å­ã€‚

æ­¤å¤–ï¼Œç›®å‰ `Resolver` ä»…æ”¯æŒä»¥ä¸‹æ–¹æ³•ï¼š

- `resolveSync`
- `resolve`
- `withOptions`

æ­¤å˜æ›´å¯èƒ½ä¼šå¯¼è‡´æŸäº›æ’ä»¶æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚

:::tip æç¤º
Rspack æ”¯æŒ [NormalModuleFactory](/api/plugin-api/normal-module-factory-hooks) çš„ [resolve](/api/plugin-api/normal-module-factory-hooks#resolve) é’©å­ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥é’©å­æ›¿ä»£ `Resolver` çš„ `resolve` é’©å­æ¥å®ç°ç›¸å…³çš„åŠŸèƒ½ã€‚

```js
compiler.hooks.normalModuleFactory.tap('PLUGIN', (normalModuleFactory) => {
  normalModuleFactory.hooks.resolve.tap('PLUGIN', (data) => {
    // é‡å®šå‘æ¨¡å—
    if (data.request === './foo.js') {
      data.request = './bar.js';
    }
  });
});
```

:::
