---
date: 2024-05-28 16:00:00
---

import { PackageManagerTabs } from '@theme';

# Rspack v0.7 发布公告

> 2024 年 5 月 28 日

![](https://assets.rspack.dev/rspack/rspack-banner-v0-7.png)

## 主要功能更新

### 支持 Lazy Compilation

Rspack 0.7.0 支持 Lazy Compilation（懒编译），Lazy Compilation 对提高多入口项目或大型项目的构建性能非常有帮助。

:::tip 什么是 lazy compilation?

Lazy Compilation 是一个提升性能的良好手段，它可以在需要时才编译代码模块，而不是在启动时就编译所有模块。这意味着开发者在启动开发服务器时，可以更快地看到应用运行，因为只有访问特定功能时，相关的模块才会被编译。

想象下面的场景：

某些你可能在第一次运行时不会使用的代码，例如，当你点击一个按钮、加载另一个页面时，如果在你开发其他东西时根本没有点击那个按钮，那么那个页面就是无用的，因此我们不需要构建它。我们在执行点击操作时才构建它。

我们尝试将入口和动态导入作为分割点，例如，考虑以下结构：

`A -动态导入()-> B -动态导入()-> C`

当我们编译 A 时，我们将 B 当成一个空文件，假装用户从未在其中编写过任何代码：

`A -动态导入()-> B'(空内容)`

一旦我们访问 B，这意味着我们确实需要构建 B，我们就用其原始内容填充 B，假装用户立即编写了内容。
:::

尽管 Rspack 目前有很好的性能，但是面对具有大量页面的项目，其性能仍然具有较大的提升空间。

以 Rspack 官网为例，Rspack 官网包含多个页面，当开启 Lazy Compilation 后，只有访问到的入口及其依赖的文件才会进行构建，这极大的提升了编译速度，使得 Rspack 官网的启动时间从 2s+ 降至 1s 内 ⚡️。

![lazy-compilation-compare](https://assets.rspack.dev/rspack/assets/lazy-compilation-compare.png)

现在，你可以通过 [experiments.lazyCompilation](/config/experiments#experimentslazycompilation) 配置项在 Rspack 中开启懒编译功能：

```file=rspack.config.js
module.exports = {
  experiments: {
    lazyCompilation: true,
  },
};
```

此特性目前仍在实验阶段，如果你在使用过程中遇到问题，欢迎通过 [GitHub Issues](https://github.com/web-infra-dev/rspack/issues) 向我们反馈。

### 更快的 Native CSS 打包速度

0.7 版本我们对 [experiments.css](/config/experiments#experimentscss) 的内部实现进行了部分重构。

主要是 CSS 依赖分析部分，从 `swc-css` 切换为了 `css-module-lexer`，在修复 css modules 边界问题的同时，也给 experiments.css 带来了更快的打包速度。

![rspack-css-lexer](https://assets.rspack.dev/rspack/assets/rspack-css-lexer.png)

经过实际测试，`bootstrap.css` 打包速度提升了4倍：

- 重构前：约 84 毫秒（分析 CSS 依赖约 71 毫秒）
- 重构后：约 25 毫秒（分析 CSS 依赖约 11 毫秒）

## 不兼容更新

Rspack 会在 1.0 版本前，逐步下线所有不稳定的 API 和配置，更多配置 / API / 默认行为将与 webpack 保持一致。

### 移除一些不稳定的 JavaScript API

Rspack 初期暴露了一些预期仅供内部使用且不稳定的 API，如 `compiler.compilation` 和 `compiler.builtinPlugins` 等，这些 API 并不稳定且无法在 webpack 中使用。

在 0.7.0 版本中，我们重新整理了目前暴露的 API 及其接口定义。如果你有使用到这些 API，你需要进行一些调整，切换到与 webpack 一致的实现方式。

以下 API 已废弃：

- `compiler.builtinPlugins`
- `compiler.compilation`
- `compiler.compilationParams`
- `compiler.getAsset(name)`
- `statsError.formatted`
- `statsWarning.formatted`
- ...

关于废弃 API 的详细情况可参考 [rspack#6448](https://github.com/web-infra-dev/rspack/pull/6448)、[rspack#6505](https://github.com/web-infra-dev/rspack/pull/6505)。

### CSS @import 规则须先于其他规则

0.7 版本我们对 [experiments.css](/config/experiments#experimentscss) 的内部实现进行了部分重构。

重构后，当 `@import` 不在最顶部时，会得到如下报错，此时需要你手动将 `@import` 规则调整到顶部。

```bash
ERROR in ./src/main.css
  × Module parse failed:
  ╰─▶   × CSS parsing warning: Any '@import' rules must precede all other rules
         ╭─[4:1]
       4 │ };
       5 │
       6 │ @import 'bootstrap/dist/css/bootstrap.css';
         · ───────
       7 │
       8 │
         ╰────

  help:
        You may need an appropriate loader to handle this file type.
```

### 移除 builtins 以及 experiments.rspackFuture.newTreeshaking

0.7.0 已移除 `builtins.treeShaking` (oldTreeShaking) 和 `experiments.rspackFuture.newTreeshaking` (新 tree shaking 开关) 配置，将旧的 tree shaking 功能彻底下线。

### 移除 resolve.browserField

该配置为 `resolve.aliasFields = ["browser"]` 的简写，由于 Rspack 已经支持 `resolve.aliasFields`，所以不再需要该配置。

### 移除 experiments.newSplitChunks

该配置用于开启新的 splitChunks 实现，由于 Rspack 已经默认使用新的 splitChunks 实现，所以不再需要该配置。

### 移除 snapshot

该配置用于配置 cache snapshot 的行为。在 Rspack 目前的增量架构下，cache 不再依赖 snapshot，所以不再需要该配置。

### 移除 generator.css.exportsConvention

该配置用于控制 experiments.css 的 CSS 模块导出的命名形式，仅对于模块类型为 `css/module` 的模块才会有导出，对于模块类型为 `css` 的模块并不存在导出，所以不需要该配置。

### 升级 SWC 到 0.91.x

升级 Rust crate `swc_core` 到 `0.91.x`，这会对使用 SWC Wasm 插件的用户产生影响。

## 迁移指南

### 升级 SWC 插件

在 `0.7.0` 中，Rust crate `swc_core` 的版本升级到 `0.91.x`，使用到的 swc wasm 插件需要确保其使用的 `swc_core` 的版本一致性，否则可能产生无法预知的问题。

详情请参考[文档](https://swc.rs/docs/plugin/selecting-swc-core#091x)。

### 替换 resolve.browserField 为 resolve.aliasFields

如果你之前配置了 `resolve.browserField`，则需要使用 `resolve.aliasFields` 进行替换：

- `resolve.browserField = true` 替换为 `resolve.aliasFields = ["browser"]`
- `resolve.browserField = false` 替换为 `resolve.aliasFields = []`

### 移除 generator.css.exportsConvention

如果你之前配置了 `module.generator.css.exportsConvention` 或在 `module.rule` 中配置了 `generator.exportsConvention`，只需要删除该配置即可。
