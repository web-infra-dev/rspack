name: Single Docker build

description: Docker build for a single target

inputs:
  target:
    required: true
    type: string
  image:
    required: true
    type: string
  profile:
    default: 'release'
    required: false
    type: string
  options:
    description: 'Options for docker'
    default: ""
    required: false
    type: string
  pre:
    required: false
    default: ""
    type: string
  post:
    required: false
    default: ""
    type: string

runs:
  using: composite
  steps:
    - name: Docker Build ${{ inputs.target }}
      shell: bash
      run: |
        code='
          set -e
          if [ -x "$(command -v sccache)" ]; then
            export RUSTC_WRAPPER=sccache
          fi
          ${{ inputs.pre }}
          rustup target add ${{ inputs.target }}
          corepack enable
          RUST_TARGET=${{ inputs.target }} pnpm build:binding:${{ inputs.profile }}
          ${{ inputs.post }}
          if [ -x "$(command -v sccache)" ]; then
            sccache --show-stats
          fi
        '

        docker run \
          --rm \
          --privileged \
          --user 0:0 \
          ${{ inputs.options }} \
          -e CI=1 \
          -e HOME=$HOME \
          -v $HOME/.cache:$HOME/.cache \
          -v ${{ github.workspace }}:/build \
          -w /build \
          -i \
          ${{ inputs.image }} \
          bash -c "$code"
