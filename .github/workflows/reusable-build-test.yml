name: Run Test

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      runner: # Runner labels
        required: true
        type: string
      ref: # Git reference to checkout
        required: false
        type: string

jobs:
  test:
    runs-on: ${{ fromJSON(inputs.runner) }}
    timeout-minutes: 60
    strategy:
      fail-fast: false # wait for all test to finish for determining if it's node version based problem or general problem
      matrix:
        node: ${{ fromJSON(
          inputs.target == 'wasm32-wasip1-threads'&& '[24]'
          || contains(inputs.target, 'linux') && '[20, 22, 24]'
          || '[22]') }}
    name: Test Node ${{ matrix.node }}
    defaults:
      run:
        shell: bash
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
      PUPPETEER_SKIP_DOWNLOAD: true
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          ref: ${{ inputs.ref }}
          clean: ${{ runner.environment == 'github-hosted' }}

      - name: Download bindings
        uses: ./.github/actions/artifact/download
        with:
          name: bindings-${{ inputs.target }}
          path: crates/node_binding/

      - name: Show restored binding
        run: ls -lah crates/node_binding/

      - name: Setup Pnpm
        timeout-minutes: 5
        uses: ./.github/actions/pnpm/setup
        with:
          node-version: ${{ matrix.node }}

      - name: Pnpm Install
        uses: ./.github/actions/pnpm/install-dependencies
        with:
          save-if: ${{ github.ref_name == 'main' && matrix.node == '20' }}

      - name: Enable core dumps (Linux)
        if: ${{ contains(inputs.target, 'linux') }}
        run: |
          ulimit -c unlimited
          mkdir -p "$GITHUB_WORKSPACE/cores"
          sudo sysctl -w kernel.core_pattern="$GITHUB_WORKSPACE/cores/core.%p.%t"
          ulimit -c

      - name: Enable core dumps (macOS)
        if: ${{ contains(inputs.target, 'apple-darwin') }}
        run: |
          ulimit -c unlimited
          ulimit -c
          mkdir -p "$GITHUB_WORKSPACE/cores"
          sudo sysctl -w kernel.core_pattern="$GITHUB_WORKSPACE/cores/core.%p.%t"

      ### x86_64-unknown-linux-gnu
      - name: Test x86_64-unknown-linux-gnu
        timeout-minutes: 15 # Tests should finish within 15 mins, please fix your tests instead of changing this to a higher timeout.
        if: ${{ inputs.target == 'x86_64-unknown-linux-gnu' }}
        run: pnpm run test:ci

      - name: Upload linux test cache
        if: ${{ inputs.target == 'x86_64-unknown-linux-gnu' && matrix.node == '22' }}
        uses: ./.github/actions/artifact/upload
        with:
          name: testCase-persistentCache-linux
          path: tests/rspack-test/js/temp/**/.cache
          force-use-github: true
          include-hidden-files: true

      ### *-apple-darwin
      - name: Test apple-darwin
        timeout-minutes: 20 # Tests should finish within 15 mins, please fix your tests instead of changing this to a higher timeout.
        if: ${{ contains(inputs.target, 'apple-darwin') }}
        run: |
          # arch is ARM and target is ARM
          if [[ '${{ runner.arch }}' == ARM* && '${{ inputs.target }}' == 'aarch64-apple-darwin' ]]; then
            pnpm run test:ci
          fi
          # arch is x64 and target is x64
          if [[ '${{ runner.arch }}' != ARM* && '${{ inputs.target }}' != 'aarch64-apple-darwin' ]]; then
            pnpm run test:ci
          fi

      ### x86_64-pc-windows-msvc
      - name: Test x86_64-pc-windows-msvc
        timeout-minutes: 10
        if: ${{ inputs.target == 'x86_64-pc-windows-msvc' }}
        run: pnpm run test:ci

      - name: Upload windows test cache
        if: ${{ inputs.target == 'x86_64-pc-windows-msvc' && matrix.node == '22' }}
        uses: ./.github/actions/artifact/upload
        with:
          name: testCase-persistentCache-windows
          path: tests/rspack-test/js/temp/**/.cache
          force-use-github: true
          include-hidden-files: true

      ### WASM
      - name: Test WASM
        timeout-minutes: 15 # Tests should finish within 15 mins, please fix your tests instead of changing this to a higher timeout.
        if: ${{ inputs.target == 'wasm32-wasip1-threads' }}
        env:
          NODE_NO_WARNINGS: 1
          WASM: 1
          RSPACK_LOADER_WORKER_THREADS: 1
        run: pnpm run test:ci

      - name: Upload streamed test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: streamed-reports-${{ inputs.target }}-node${{ matrix.node }}
          path: |
            rspack-test-streamed-report.txt
            rspack-cli-streamed-report.txt
          if-no-files-found: ignore

      - name: Upload core dumps
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-dumps-${{ inputs.target }}-node${{ matrix.node }}
          path: ./cores/
          if-no-files-found: ignore
