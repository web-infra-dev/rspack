name: Test new runner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  get-runner-labels:
    name: Get Runner Labels
    uses: ./.github/workflows/get-runner-labels.yml

  comment-test:
    name: Test trigger by comment
    needs: [get-runner-labels]
    if: (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') && contains(github.event.comment.body, '!test-ng')
    strategy:
      matrix:
        array:
          - target: x86_64-unknown-linux-gnu
            runner: ${{ needs.get-runner-labels.outputs.LINUX_RUNNER_LABELS }}
    uses: ./.github/workflows/reusable-build.yml
    with:
      profile: "debug"
      ref: refs/pull/${{ github.event.issue.number || github.event.pull_request.number }}/head
      target: ${{ matrix.array.target }}
      runner: ${{ matrix.array.runner }}
      test-ng: true

  schedule-test:
    name: Test trigger by schedule
    needs: [get-runner-labels]
    if: (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    strategy:
      matrix:
        array:
          - target: x86_64-unknown-linux-gnu
            runner: ${{ needs.get-runner-labels.outputs.LINUX_RUNNER_LABELS }}
    uses: ./.github/workflows/reusable-build.yml
    with:
      profile: "debug"
      target: ${{ matrix.array.target }}
      runner: ${{ matrix.array.runner }}
      test-ng: true

  notify:
    name: Notify if failed
    needs: [schedule-test]
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'web-infra-dev' && failure() && !cancelled() }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - shell: bash
        run: ./scripts/alert/lark.js
        env:
          TITLE: New Runner failed
          DESCRIPTION: |
            commitID: [${{github.sha}}](${{github.server_url}}/${{github.repository}}/commit/${{github.sha}})
          URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}
          LARK_WEBHOOK_URL: ${{secrets.LARK_WEBHOOK_URL}}
