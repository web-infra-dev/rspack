name: Ecosystem Benchmark

on:
  workflow_dispatch:
    inputs:
      commit_id:
        type: string
        description: "the full sha1 commit id"
        required: false

  push:
    branches:
      - main
    paths-ignore:
      - "**/*.md"
      - "website/**"
    tags-ignore:
      - "**"

permissions:
  # Allow commenting on commits
  contents: write
  # Allow commenting on issues
  issues: write
  # Allow commenting on pull requests
  pull-requests: write

jobs:
  get-runner-labels:
    name: Get Runner Labels
    uses: ./.github/workflows/get-runner-labels.yml

  build:
    name: Test Linux
    needs: [get-runner-labels]
    uses: ./.github/workflows/reusable-build.yml
    with:
      target: x86_64-unknown-linux-gnu
      runner: ${{ fromJSON(vars.LINUX_SELF_HOSTED_RUNNER_LABELS || '"ubuntu-latest"') }}
      ref: ${{ github.sha }}
      profile: "release"
      test: false
      bench: false
      prefer_docker: false

  bench:
    environment: eco-perf
    needs: [build]
    runs-on: [self-hosted, benchmark]
    outputs:
      diff-result: ${{ steps.run-benchmark.outputs.diff-result }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ github.sha }}

      - name: Clean
        uses: ./.github/actions/clean
        with:
          target: x86_64-unknown-linux-gnu

      - name: Download bindings
        uses: ./.github/actions/artifact/download
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: crates/node_binding/
          force-use-github: true

      - name: Show restored binding
        shell: bash
        run: ls -lah crates/node_binding/*.node

      - name: Pnpm Setup
        uses: ./.github/actions/pnpm/setup

      - name: Pnpm Install
        uses: ./.github/actions/pnpm/install-dependencies

      - name: Build JS
        run: pnpm run build:js

      - name: Run rspack-ecosystem-benchmark
        id: run-benchmark
        run: |
          RSPACK_DIR=$(pwd)
          git clone --single-branch --depth 1 https://github.com/web-infra-dev/rspack-ecosystem-benchmark.git
          cd rspack-ecosystem-benchmark
          pnpm i
          RSPACK_DIR="$RSPACK_DIR" node bin/cli.js bench
          result=$(node bin/cli.js compare --base latest --current current)
          echo "$result"
          echo "diff-result=${result//$'\n'/'@@'}" >> $GITHUB_OUTPUT

      - name: Upload benchmark result
        id: upload-benchmark-data
        run: |
          RSPACK_DIR=$(pwd)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          cd rspack-ecosystem-benchmark
          RSPACK_DIR="$RSPACK_DIR" GITHUB_ACTOR=x-access-token node bin/upload.js bench ${{ secrets.PERF_DATA_TOKEN }} ${{ github.sha }}
