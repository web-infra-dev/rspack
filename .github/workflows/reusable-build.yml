name: Reusable Release

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      runner: # Runner labels
        required: true
        type: string
      test-runner: # Test Runner labels
        required: false
        type: string
      profile: # Rust profile, "ci" or "production" or "profiling"
        default: "ci"
        required: false
        type: string
      test: # Run tests?
        type: boolean
        required: false
        default: false
      bench: # Run benchmarks?
        type: boolean
        required: false
        default: false
      ref: # Git reference to checkout
        required: false
        type: string

permissions:
  # Allow commenting on issues
  issues: write

jobs:
  build:
    uses: ./.github/workflows/reusable-build-build.yml
    with:
      target: ${{ inputs.target }}
      runner: ${{ inputs.runner }}
      profile: ${{ inputs.profile }}
      ref: ${{ inputs.ref }}
  test:
    if: inputs.test
    needs: build
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      target: ${{ inputs.target }}
      runner: ${{ inputs.test-runner || inputs.runner }}
      ref: ${{ inputs.ref }}
  codspeed:
    name: Codspeed-build
    if: inputs.bench
    runs-on: ${{  fromJSON(vars.LINUX_SELF_HOSTED_RUNNER_LABELS || '"ubuntu-latest"' ) }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ inputs.ref }}
          clean: ${{ runner.environment == 'github-hosted' }}

      - name: Install Rust Toolchain
        uses: ./.github/actions/rustup
        with:
          save-if: true
          key: build-bench-${{ inputs.target }}

      - name: Install cargo-codspeed binary
        uses: taiki-e/install-action@1cefd1553b1693f47889dc747f7d230904296a3b # v2
        with:
          tool: cargo-codspeed@2.10.1

      - name: Build Benchmark
        env:
          RUSTFLAGS: "-C debuginfo=1 -C strip=none -g --cfg codspeed"
        run: cargo codspeed build -p rspack_benchmark --features codspeed

      - name: Upload Artifact
        uses: ./.github/actions/artifact/upload
        with:
          name: codspeed-${{ inputs.target }}
          path: |
            target/codspeed/**/

  bench:
    uses: ./.github/workflows/reusable-build-bench.yml
    if: inputs.bench
    needs: [build, codspeed]
    with:
      target: ${{ inputs.target }}
      runner: '"ubuntu-22.04"'
      ref: ${{ inputs.ref }}
