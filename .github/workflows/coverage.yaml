# disabled when using private

# name: Rust coverage

# on:
#   push:
#     branches:
#       - main
#     tags-ignore:
#       - "**"
#   pull_request:

# env:
#   TRACE: DEBUG

# jobs:
#   cargo-coverage:
#     name: Cargo test
#     strategy:
#       fail-fast: false
#       matrix:
#         os:
#           - ubuntu-latest
#     runs-on: ${{ matrix.os }}
#     steps:
#       - uses: actions/checkout@v3
#       - name: Install minimal nightly
#         uses: actions-rs/toolchain@v1
#         with:
#           profile: minimal
#           toolchain: nightly
#           components: llvm-tools-preview
#           override: true
#       - name: Install grcov
#         run: cargo install grcov
#       - name: Configure cache
#         uses: actions/cache@v2
#         with:
#           path: |
#             ~/.cargo/bin/
#             ~/.cargo/registry/index/
#             ~/.cargo/registry/cache/
#             ~/.cargo/git/db/
#             target/
#           key: test-${{ runner.os }}-cargo-gcc-${{ matrix.gcc }}-clang-${{ matrix.clang }}-${{ hashFiles('**/Cargo.lock') }}
#       - name: Build
#         env:
#           RUSTFLAGS: -Cinstrument-coverage
#         run: cargo build
#       - name: Test
#         env:
#           RUSTFLAGS: -Cinstrument-coverage
#           LLVM_PROFILE_FILE: coverage-%p-%m.profraw
#         run: cargo test
#       - name: Generate coverage
#         id: coverage
#         run: |
#           grcov $(find . -name "coverage-*.profraw" -print) \
#             --branch \
#             --ignore-not-existing \
#             --binary-path ./target/debug/ \
#             -s . \
#             -t lcov \
#             --ignore "/*" \
#             -o lcov.info
#       - name: Codecov
#         uses: codecov/codecov-action@v2.1.0
#         with:
#           token: ${{ secrets.CODECOV_TOKEN }}
#           files: ./lcov.info
#           fail_ci_if_error: true
